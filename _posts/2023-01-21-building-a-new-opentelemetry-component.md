![thumnail](images/DALLÂ·E\ 2023-01-21\ 09.39.03\ -\ \ streams\ of\ zero\ and\ one\ digits\ flowing\ through\ a\ \ transport\ map.png images)

# Building a New OpenTelemetry Component

By Alan Jones

As a developer you want a quick edit/compile/test cycle.  This article demonstrates how to create such a development environment for developing new OpenTelemetry (OTel) components, i.e. recievers, processors, and exporters.

## OpenTelemetry Collector Builder
We start with the [OpenTelemetry Collector Builder](https://github.com/open-telemetry/opentelemetry-collector/tree/main/cmd/builder).  These instructions let you choose which existing components to import into your collector.  As I'm working on a logs exporter, I choose the syslog receiver, processors resourcedetector (to add host.name metadata), batch, and exporter logging as my example code.
```
~$ cd otel
~/otel$ cat 
dist:
  name: otelcol-custom
  description: Local OpenTelemetry Collector binary
  output_path: .

exporters:
  - gomod: go.opentelemetry.io/collector/exporter/loggingexporter v0.69.0

receivers:
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/syslogreceiver v0.69.0

processors:
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/processor/resourcedetectionprocessor v0.69.0
  - gomod: go.opentelemetry.io/collector/processor/batchprocessor v0.69.0

```
At this time v0.69.1 is the latest version, but not all components had been updated so I used the  previous version.  It is also useful to clear out your ${GOPATH} to avoid conflicts.  Here I have downloaded the most resent builder binary and installed it in my execution path.
```
~/otel$ sudo rm -rf ${GOPATH}
~/otel$ builder --config=otelcol-builder.yaml
2023-01-20T11:38:59.576-0800	INFO	internal/command.go:125	OpenTelemetry Collector Builder	{"version": "0.69.1", "date": "2023-01-12T18:18:12Z"}
2023-01-20T11:38:59.578-0800	INFO	internal/command.go:158	Using config file	{"path": "otelcol-builder.yaml"}
2023-01-20T11:38:59.578-0800	INFO	builder/config.go:107	Using go	{"go-executable": "/usr/local/go/bin/go"}
2023-01-20T11:38:59.579-0800	INFO	builder/main.go:76	Sources created	{"path": "."}
2023-01-20T11:39:12.239-0800	INFO	builder/main.go:118	Getting go modules
2023-01-20T11:39:14.666-0800	INFO	builder/main.go:87	Compiling
2023-01-20T11:39:27.640-0800	INFO	builder/main.go:99	Compiled	{"binary": "./otelcol-custom"}
```

If it complains about a module version you can list available module versions like so:
```
~/otel$ go list -m -versions go.opentelemetry.io/collector/processor/batchprocessor
go.opentelemetry.io/collector/processor/batchprocessor v0.64.0 v0.64.1 v0.65.0 v0.66.0 v0.67.0 v0.68.0 v0.69.0 v0.69.1
```
## Using an Existing Component as a Template
Next I copied the [Logging Exporter](https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/loggingexporter) directory into this project and renamed it to myappexporter.  I then replaced all references to the module path to it's future destination in the contrib repo 'github.com/open-telemetry/opentelemetry-collector-contrib/exporter/myappexporter' and made this change in components.go in the top level directory, as well as changed the config name in factory.go to 'myapp'.

Next we need to tell Go not to fetch this new module from github.com but instead compile it from our local source.  Here is my resulting go.mod using my local myappexporter with the replace command at the bottom:
```
// Code generated by "go.opentelemetry.io/collector/cmd/builder". DO NOT EDIT.

module go.opentelemetry.io/collector/cmd/builder

go 1.18

require (
	github.com/open-telemetry/opentelemetry-collector-contrib/exporter/myappexporter v0.69.0
	github.com/open-telemetry/opentelemetry-collector-contrib/processor/resourcedetectionprocessor v0.69.0
	github.com/open-telemetry/opentelemetry-collector-contrib/receiver/syslogreceiver v0.69.0
	github.com/stretchr/testify v1.8.1
	go.opentelemetry.io/collector v0.69.1
	go.opentelemetry.io/collector/component v0.69.1
	go.opentelemetry.io/collector/processor/batchprocessor v0.69.0
	golang.org/x/sys v0.4.0
)

require (
... (list omitted) ...
)

replace github.com/open-telemetry/opentelemetry-collector-contrib/exporter/myappexporter => ./myappexporter
```

## Build
Here I've copied the build flags from the builder source:
```
~/otel$ go mod tidy
~/otel$ go build -ldflags="-s -w" -trimpath -o otelcol-custom
```
## Running the Collector
My sample pipeline config with a syslog receiver:
```
~/otel$ cat otelcol.yaml
receivers:
  syslog:
    tcp:
      listen_address: "0.0.0.0:54526"
    protocol: rfc5424

processors:
  batch:
  resourcedetection:

exporters:
  myapp:
    verbosity: detailed

service:
  pipelines:
    logs:
      receivers: [syslog]
      processors: [batch,resourcedetection]
      exporters: [myapp]
```
Starting the collector:
```
~/otel$ ./otelcol-custom --config=otelcol.yaml
2023-01-20T12:25:35.579-0800	info	service/telemetry.go:92	Setting up own telemetry...
2023-01-20T12:25:35.579-0800	info	service/telemetry.go:118	Serving Prometheus metrics	{"address": ":8888", "level": "Basic"}
2023-01-20T12:25:35.579-0800	info	exporter/exporter.go:290	Development component. May change in the future.	{"kind": "exporter", "data_type": "logs", "name": "myapp"}
2023-01-20T12:25:35.599-0800	info	service/service.go:123	Starting otelcol-custom...	{"Version": "1.0.0", "NumCPU": 8}
2023-01-20T12:25:35.599-0800	info	extensions/extensions.go:42	Starting extensions...
2023-01-20T12:25:35.599-0800	info	service/pipelines.go:77	Starting exporters...
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:81	Exporter is starting...	{"kind": "exporter", "data_type": "logs", "name": "myapp"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:85	Exporter started.	{"kind": "exporter", "data_type": "logs", "name": "myapp"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:89	Starting processors...
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:93	Processor is starting...	{"kind": "processor", "name": "resourcedetection", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	internal/resourcedetection.go:136	began detecting resource information	{"kind": "processor", "name": "resourcedetection", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	internal/resourcedetection.go:150	detected resource information	{"kind": "processor", "name": "resourcedetection", "pipeline": "logs", "resource": {}}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:97	Processor started.	{"kind": "processor", "name": "resourcedetection", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:93	Processor is starting...	{"kind": "processor", "name": "batch", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:97	Processor started.	{"kind": "processor", "name": "batch", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:101	Starting receivers...
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:105	Receiver is starting...	{"kind": "receiver", "name": "syslog", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	adapter/receiver.go:56	Starting stanza receiver	{"kind": "receiver", "name": "syslog", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	service/pipelines.go:109	Receiver started.	{"kind": "receiver", "name": "syslog", "pipeline": "logs"}
2023-01-20T12:25:35.600-0800	info	service/service.go:140	Everything is ready. Begin running and processing data.
```
And sending it some data from another window:
```
~$ loggen -n 2 0.0.0.0 54526
average rate = 10101.01 msg/sec, count=2, time=0.000, (average) msg size=256, bandwidth=2523.80 kB/sec
```
## Conclusion
The end result is a relatively simple environment that you can iterate on as you develop your component.